{% extends 'admin/base.html' %}

{% block title %}RIBS Deploy Configuration{% endblock %}

{% block content %}
<div class="container">
  <h2>RIBS Deploy Thresholds</h2>
  <form id="ribs-config-form">
    <div class="form-group">
      <label for="min_return">Min Return</label>
      <input type="number" step="0.01" class="form-control" id="min_return" name="ribs_deploy_min_return">
    </div>
    <div class="form-group">
      <label for="min_sharpe">Min Sharpe</label>
      <input type="number" step="0.01" class="form-control" id="min_sharpe" name="ribs_deploy_min_sharpe">
    </div>
    <div class="form-group">
      <label for="max_drawdown">Max Drawdown (%)</label>
      <input type="number" step="0.1" class="form-control" id="max_drawdown" name="ribs_deploy_max_drawdown">
    </div>
    <div class="form-group">
      <label for="min_win_rate">Min Win Rate (0-1)</label>
      <input type="number" step="0.01" class="form-control" id="min_win_rate" name="ribs_deploy_min_win_rate">
    </div>
    <div class="form-group">
      <label for="backtest_hours">Backtest Hours</label>
      <input type="number" step="1" class="form-control" id="backtest_hours" name="ribs_deploy_backtest_hours">
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
  </form>

  <div id="ribs-config-status" class="mt-3"></div>
</div>

<script>
async function fetchConfig(){
  const r = await fetch('/admin/api/ribs/config');
  const j = await r.json();
  if (j.error){
    document.getElementById('ribs-config-status').innerText = j.error;
    return;
  }
  const e = j.effective || {};
  document.getElementById('min_return').value = e.ribs_deploy_min_return ?? '';
  document.getElementById('min_sharpe').value = e.ribs_deploy_min_sharpe ?? '';
  document.getElementById('max_drawdown').value = e.ribs_deploy_max_drawdown ?? '';
  document.getElementById('min_win_rate').value = e.ribs_deploy_min_win_rate ?? '';
  document.getElementById('backtest_hours').value = e.ribs_deploy_backtest_hours ?? '';
}

fetchConfig();

document.getElementById('ribs-config-form').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const body = {
    ribs_deploy_min_return: parseFloat(document.getElementById('min_return').value),
    ribs_deploy_min_sharpe: parseFloat(document.getElementById('min_sharpe').value),
    ribs_deploy_max_drawdown: parseFloat(document.getElementById('max_drawdown').value),
    ribs_deploy_min_win_rate: parseFloat(document.getElementById('min_win_rate').value),
    ribs_deploy_backtest_hours: parseInt(document.getElementById('backtest_hours').value, 10),
  };
  const r = await fetch('/admin/api/ribs/config', {
    method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
  });
  const j = await r.json();
  if (j.error) {
    document.getElementById('ribs-config-status').innerText = 'Error: ' + j.error;
  } else {
    document.getElementById('ribs-config-status').innerText = 'Saved successfully.';
  }
});
</script>
{% endblock %}
