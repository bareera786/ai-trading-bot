<!-- jsHint ignore: start -->
<!-- eslint-disable -->
<!-- jshint ignore: start -->
<div class="ribs-dashboard">
    <h2>üß¨ RIBS Strategy Evolution</h2>

    <div class="ribs-stats">
        <div class="stat-card">
            <h4>Archive Coverage</h4>
            <div class="progress">
                <div class="progress-bar"></div>
            </div>
            <span>{{ ribs_optimization.coverage|default(0)|round(1) }}%</span>
        </div>

        <div class="stat-card">
            <h4>Elite Strategies</h4>
            <span class="big-number">{{ ribs_optimization.num_elites|default(0) }}</span>
        </div>

        <div class="stat-card">
            <h4>Best Objective</h4>
            <span class="big-number {{ 'positive' if ribs_optimization.best_objective|default(0) > 0 else 'negative' }}">
                {{ ribs_optimization.best_objective|default(0)|round(2) }}%
            </span>
        </div>

        <div class="stat-card">
            <h4>QD Score</h4>
            <span class="big-number">{{ ribs_optimization.qd_score|default(0)|round(2) }}</span>
        </div>
    </div>

    <div class="ribs-visualization">
        <h4>Behavior Space (3D Scatter)</h4>
        <div id="ribs-3d-plot"></div>
        <script id="ribs-data" type="text/plain">{{ ribs_optimization|tojson }}</script>

        <script>
        // RIBS Dashboard JavaScript functions
        const ribsData = JSON.parse(document.getElementById('ribs-data').textContent || '{}');

        // Set dynamic styles
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = (ribsData.coverage || 0) + '%';
        }

        // Plotly 3D visualization of RIBS archive
        if (typeof Plotly !== 'undefined') {
            const behaviorsX = ribsData.behaviors_x || [];
            const behaviorsY = ribsData.behaviors_y || [];
            const behaviorsZ = ribsData.behaviors_z || [];
            const objectives = ribsData.objectives || [];

            if (behaviorsX.length > 0) {
                Plotly.newPlot('ribs-3d-plot', {
                    data: [{
                        x: behaviorsX,
                        y: behaviorsY,
                        z: behaviorsZ,
                        mode: 'markers',
                        marker: {
                            size: 8,
                            color: objectives,
                            colorscale: 'Viridis',
                            showscale: true,
                            colorbar: {
                                title: 'Total Return %'
                            }
                        },
                        type: 'scatter3d'
                    }],
                    layout: {
                        title: 'RIBS Archive: Return vs Drawdown vs Win Rate',
                        scene: {
                            xaxis: {title: 'Sharpe Ratio'},
                            yaxis: {title: 'Max Drawdown %'},
                            zaxis: {title: 'Win Rate'}
                        },
                        margin: {l: 0, r: 0, t: 40, b: 0},
                        height: 500
                    }
                });
            } else {
                document.getElementById('ribs-3d-plot').innerHTML =
                    '<div class="no-data">No RIBS data available yet. Optimization in progress...</div>';
            }
        } else {
            document.getElementById('ribs-3d-plot').innerHTML =
                '<div class="no-data">Plotly not loaded. Install plotly for 3D visualization.</div>';
        }
        </script>
    </div>

    <!-- Toast container for non-blocking notifications -->
    <div id="ribs-toast-container" style="position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:10px;"></div>

    <div class="elite-strategies">
        <h4>Top 5 Elite Strategies</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Total Return</th>
                    <th>Sharpe Ratio</th>
                    <th>Max Drawdown</th>
                    <th>Win Rate</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for strategy in ribs_optimization.elite_strategies|default([]) %}
                <tr>
                    <td>#{{ loop.index }}</td>
                    <td class="{{ 'positive' if strategy.objective > 0 else 'negative' }}">
                        {{ strategy.objective|round(2) }}%
                    </td>
                    <td>{{ strategy.behavior[0]|round(2) }}</td>
                    <td>{{ strategy.behavior[1]|round(2) }}%</td>
                    <td>{{ (strategy.behavior[2] * 100)|round(1) }}%</td>
                    <td>
                        <button class="btn btn-sm btn-success deploy-ribs-btn"
                                data-strategy-id="{{ strategy.id|tojson }}">
                            üöÄ Deploy
                        </button>
                        <button class="btn btn-sm btn-info analyze-ribs-btn"
                                data-strategy-id="{{ strategy.id|tojson }}">
                            üìä Analyze
                        </button>
                        <button class="btn btn-sm btn-warning export-ribs-btn"
                                data-strategy-id="{{ strategy.id|tojson }}">
                            üíæ Export
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% if not ribs_optimization.elite_strategies|default([]) %}
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No elite strategies found yet. RIBS optimization is running...
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="ribs-controls">
        <h4>Optimization Controls</h4>
        <div class="control-buttons">
            <div id="ribs-status-widget" class="stat-card" style="min-width:200px;align-self:center;">
                <h5>RIBS Status</h5>
                <div id="ribs-status-content">Loading...</div>
                <div id="ribs-progress" style="margin-top:10px;display:none;">
                    <div class="progress" style="height:14px;">
                        <div id="ribs-progress-bar" class="progress-bar" style="height:14px;width:0%"></div>
                    </div>
                    <div id="ribs-progress-text" style="font-size:12px;margin-top:6px;color:#666;">--</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="startRIBSOptimization()">
                ‚ñ∂Ô∏è Start RIBS Optimization
            </button>
            <button class="btn btn-secondary" onclick="pauseRIBSOptimization()">
                ‚è∏Ô∏è Pause Optimization
            </button>
            <button class="btn btn-danger" onclick="resetRIBSArchive()">
                üîÑ Reset Archive
            </button>
            <button class="btn btn-info" onclick="exportRIBSData()">
                üíæ Export Archive
            </button>
        </div>
    </div>

    <div class="ribs-parameters">
        <h4>Strategy Parameters (Latest Elite)</h4>
// Poll ribs status and update the status widget
function updateRIBSStatusWidget() {
    // Fetch both archive status and progress
    fetch('/api/ribs/progress')
    .then(r => r.json())
    .then(data => {
        const el = document.getElementById('ribs-status-content');
        if (!el) return;
        // `data` here is progress object from /api/ribs/progress
        if (data.status === 'missing') {
            el.innerHTML = '<div class="text-muted">Unavailable</div>';
            return;
        }
        const running = data.running ? 'Running' : 'Idle';
        el.innerHTML = `<div><strong>${running}</strong></div>`;

        // Update progress bar if present
        const progressBarWrap = document.getElementById('ribs-progress');
        const progressBar = document.getElementById('ribs-progress-bar');
        const progressText = document.getElementById('ribs-progress-text');
        if (data.progress_percent != null) {
            if (progressBarWrap) progressBarWrap.style.display = 'block';
            if (progressBar) progressBar.style.width = Math.max(0, Math.min(100, data.progress_percent)) + '%';
            if (progressText) progressText.textContent = `Iteration ${data.current_iteration || 0} ‚Äî ${data.progress_percent}%`;
        } else {
            if (progressBarWrap) progressBarWrap.style.display = 'none';
        }
    })
    .catch(() => {
        const el = document.getElementById('ribs-status-content');
        if (el) el.innerHTML = '<div class="text-danger">Error fetching status</div>';
    });
}

// Start polling every 2 seconds for live progress updates
setInterval(updateRIBSStatusWidget, 2000);
// Initial update
updateRIBSStatusWidget();

function showRibsToast(msg, kind = 'info') {
    const container = document.getElementById('ribs-toast-container');
    if (!container) return;
    const el = document.createElement('div');
    el.className = `toast toast-${kind}`;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(() => { el.remove(); }, 5000);
}

function startRIBSOptimization() {
    fetch('/api/ribs/start', {method: 'POST'})
        .then(r => r.json())
        .then(j => {
            if (j && j.success) {
                showRibsToast('RIBS optimization started', 'info');
            } else {
                showRibsToast('Failed to start RIBS: ' + (j.error || 'unknown'), 'danger');
            }
            setTimeout(updateRIBSStatusWidget, 800);
        })
        .catch(() => showRibsToast('Failed to start RIBS', 'danger'));
}

function pauseRIBSOptimization() {
    fetch('/api/ribs/pause', {method: 'POST'})
        .then(r => r.json())
        .then(j => {
            if (j && j.success) {
                showRibsToast('RIBS optimization paused', 'info');
            } else {
                showRibsToast('Failed to pause RIBS: ' + (j.error || 'unknown'), 'danger');
            }
            setTimeout(updateRIBSStatusWidget, 800);
        })
        .catch(() => showRibsToast('Failed to pause RIBS', 'danger'));
}

        {% if ribs_optimization.elite_strategies|default([]) %}
        <div class="params-grid">
            {% set latest = ribs_optimization.elite_strategies[0] %}
            {% for key, value in latest.params.items() %}
            <div class="param-item">
                <label>{{ key|replace('_', ' ')|title }}</label>
                <span class="param-value">{{ value|round(3) if value is number else value }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-data">No parameter data available</div>
        {% endif %}
    </div>
</div>

<style>
.ribs-dashboard {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    margin: 20px 0;
}

.ribs-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-card h4 {
    margin: 0 0 10px 0;
    color: #666;
    font-size: 14px;
    text-transform: uppercase;
}

.progress {
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    margin-bottom: 10px;
}

.progress-bar {
    background: linear-gradient(90deg, #28a745, #20c997);
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

.big-number {
    font-size: 2em;
    font-weight: bold;
    color: #333;
}

.positive {
    color: #28a745 !important;
}

.negative {
    color: #dc3545 !important;
}

.ribs-visualization {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.ribs-visualization h4 {
    margin-bottom: 20px;
    color: #333;
}

#ribs-3d-plot {
    width: 100%;
    height: 500px;
}

.elite-strategies, .ribs-controls, .ribs-parameters {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th, .table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.control-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.param-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.param-item label {
    font-weight: 600;
    color: #495057;
}

.param-value {
    font-family: monospace;
    background: white;
    padding: 2px 6px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
}

.no-data {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 40px;
}

/* RIBS toast styles */
.ribs-toast {
    min-width: 240px;
    max-width: 420px;
    padding: 10px 14px;
    border-radius: 8px;
    color: #fff;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
.ribs-toast-info { background: linear-gradient(90deg,#3b82f6,#60a5fa); }
.ribs-toast-success { background: linear-gradient(90deg,#10b981,#34d399); }
.ribs-toast-error { background: linear-gradient(90deg,#ef4444,#f97316); }
</style>

<script>
// RIBS Dashboard JavaScript functions
function deployRIBSStrategy(strategyId) {
    if (!confirm(`Deploy RIBS strategy ${strategyId} to live trading?`)) return;

    // Show a temporary 'starting' toast
    const startToastId = showRibsToast('Starting deployment...', 'info', 5000);

    fetch(`/api/ribs/deploy/${strategyId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(async response => {
        const data = await response.json().catch(() => ({}));
        if (response.ok && data.success) {
            showRibsToast('Strategy deployed successfully!', 'success', 4000);
            // update UI after a short delay so the toast can be seen
            setTimeout(() => location.reload(), 800);
        } else {
            const message = (data && (data.error || data.message)) || `Deployment failed (HTTP ${response.status})`;
            showRibsToast(message, 'error', 8000);
        }
    })
    .catch(error => {
        showRibsToast('Error deploying strategy: ' + (error.message||error), 'error', 8000);
    });
}

// Simple toast helper for the RIBS dashboard
function showRibsToast(text, type='info', timeout=5000) {
    const container = document.getElementById('ribs-toast-container');
    if (!container) return null;
    const toast = document.createElement('div');
    toast.className = `ribs-toast ribs-toast-${type}`;
    toast.textContent = text;
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.25s ease, transform 0.25s ease';
    toast.style.transform = 'translateY(-6px)';
    container.appendChild(toast);
    // animate in
    requestAnimationFrame(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; });
    if (timeout > 0) setTimeout(() => {
        toast.style.opacity = '0'; toast.style.transform = 'translateY(-6px)';
        setTimeout(() => toast.remove(), 260);
    }, timeout);
    return toast;
}

function analyzeRIBSStrategy(strategyId) {
    window.open(`/ribs/analyze/${strategyId}`, '_blank');
}

function exportRIBSParams(strategyId) {
    fetch(`/api/ribs/export/${strategyId}`)
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ribs_strategy_${strategyId}_params.json`;
        a.click();
        window.URL.revokeObjectURL(url);
    });
}

function startRIBSOptimization() {
    fetch('/api/ribs/start', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        alert(data.message || 'RIBS optimization started');
    });
}

function pauseRIBSOptimization() {
    fetch('/api/ribs/pause', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        alert(data.message || 'RIBS optimization paused');
    });
}

function resetRIBSArchive() {
    if (confirm('Reset RIBS archive? This will clear all optimization progress.')) {
        fetch('/api/ribs/reset', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Archive reset');
            location.reload();
        });
    }
}

function exportRIBSData() {
    fetch('/api/ribs/export')
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ribs_archive_data.json';
        a.click();
        window.URL.revokeObjectURL(url);
    });
}

// Event listeners for RIBS strategy buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.deploy-ribs-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            deployRIBSStrategy(this.dataset.strategyId);
        });
    });

    document.querySelectorAll('.analyze-ribs-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            analyzeRIBSStrategy(this.dataset.strategyId);
        });
    });

    document.querySelectorAll('.export-ribs-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            exportRIBSParams(this.dataset.strategyId);
        });
    });
});
</script>

<div class="ribs-logs">
    <h4>RIBS Logs</h4>
    <div id="ribs-logs-container" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-lg); max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.4;">
        <div id="ribs-logs-content">Loading logs...</div>
    </div>
    <button class="btn btn-info" onclick="refreshRIBSLogs()" style="background: #00d4aa; color: white; border: 1px solid #00b894; border-radius: 6px; padding: 8px 16px; font-size: 14px; font-weight: 500; cursor: pointer;">Refresh Logs</button>
</div>

<script>
// Function to refresh RIBS logs
function refreshRIBSLogs() {
    const container = document.getElementById('ribs-logs-content');
    container.textContent = 'Loading logs...';

    fetch('/api/ribs/logs')
    .then(r => r.json())
    .then(data => {
        if (data.logs && data.logs.length > 0) {
            container.innerHTML = data.logs.map(log => `<div style="margin-bottom: 4px;">${log}</div>`).join('');
        } else {
            container.textContent = 'No RIBS logs found.';
        }
    })
    .catch(error => {
        container.textContent = 'Error loading logs: ' + error.message;
    });
}

// Load logs on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshRIBSLogs();
});
</script>

<!-- jshint ignore: end -->
<!-- eslint-enable -->
